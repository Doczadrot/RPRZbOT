name: ğŸš‚ Railway Production Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      skip_health_check:
        description: 'Skip health check after deploy'
        required: false
        default: 'false'

jobs:
  pre-deploy-check:
    name: ğŸ” Pre-Deploy Validation
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ” Check deploy readiness
      run: |
        python check_deploy_ready.py

    - name: âœ… All pre-checks passed
      run: |
        echo "âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ² Ğº Ğ´ĞµĞ¿Ğ»Ğ¾Ñ Ğ½Ğ° Railway Production"

  wait-for-tests:
    name: â³ Wait for Tests to Pass
    runs-on: ubuntu-latest
    needs: pre-deploy-check

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3

    - name: â³ Wait for test workflow
      uses: lewagon/wait-on-check-action@v1.3.1
      with:
        ref: ${{ github.ref }}
        check-name: 'ğŸ Python Tests'
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        wait-interval: 10

    - name: âœ… Tests passed
      run: echo "âœ… Ğ’ÑĞµ Ñ‚ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾"

  deploy-notification-start:
    name: ğŸ“¢ Deploy Start Notification
    runs-on: ubuntu-latest
    needs: wait-for-tests
    if: always()

    steps:
    - name: ğŸ“¢ Notify deploy started
      run: |
        echo "ğŸš€ ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° Railway Production"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Author: ${{ github.actor }}"
        echo "ğŸ’¬ Message: ${{ github.event.head_commit.message }}"

  # Railway Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¸Ñ‚ Ğ¸Ğ· GitHub Ğ¿Ñ€Ğ¸ push Ğ² main
  # Ğ­Ñ‚Ğ¾Ñ‚ job Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ
  railway-auto-deploy:
    name: ğŸš‚ Railway Auto Deploy
    runs-on: ubuntu-latest
    needs: wait-for-tests

    steps:
    - name: ğŸ“¢ Railway deploying
      run: |
        echo "ğŸš‚ Railway Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ¸Ğ· GitHub"
        echo "ğŸ“ Branch: ${{ github.ref_name }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo ""
        echo "ĞÑ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ¹Ñ‚Ğµ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ Ğ½Ğ° Railway Dashboard:"
        echo "https://railway.app"

  health-check:
    name: ğŸ¥ Post-Deploy Health Check
    runs-on: ubuntu-latest
    needs: railway-auto-deploy
    if: github.event.inputs.skip_health_check != 'true'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ğŸ“¦ Install dependencies
      run: |
        pip install requests

    - name: â³ Wait for Railway deploy
      run: |
        echo "â³ ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ Railway..."
        echo "Ğ”Ğ°Ñ‘Ğ¼ Railway 60 ÑĞµĞºÑƒĞ½Ğ´ Ğ½Ğ° Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ°"
        sleep 60

    - name: ğŸ¥ Run health check
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      run: |
        if [ -z "$BOT_TOKEN" ]; then
          echo "âš ï¸ BOT_TOKEN Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ Ğ² GitHub Secrets"
          echo "ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ health check"
          exit 0
        fi
        python scripts/deploy_health_check.py
      continue-on-error: true

    - name: âœ… Health check complete
      run: |
        echo "âœ… Health check Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½"

  smoke-tests:
    name: ğŸ”¥ Smoke Tests
    runs-on: ubuntu-latest
    needs: health-check
    if: always() && needs.health-check.result != 'failure'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ğŸ“¦ Install test dependencies
      run: |
        pip install pytest requests

    - name: ğŸ”¥ Run smoke tests
      run: |
        # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ smoke-Ñ‚ĞµÑÑ‚Ñ‹ (ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ¸ Ğ¿Ğ¾Ğ¼ĞµÑ‡ĞµĞ½Ñ‹ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¼ Ğ¼Ğ°Ñ€ĞºĞµÑ€Ğ¾Ğ¼)
        python -m pytest tests/ -m smoke -v || echo "âš ï¸ No smoke tests found"
      continue-on-error: true

  deploy-notification-end:
    name: ğŸ“¢ Deploy Complete Notification
    runs-on: ubuntu-latest
    needs: [smoke-tests, health-check]
    if: always()

    steps:
    - name: ğŸ“Š Determine deploy status
      id: status
      run: |
        if [ "${{ needs.health-check.result }}" = "success" ]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "icon=âœ…" >> $GITHUB_OUTPUT
          echo "message=Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ ÑƒÑĞ¿ĞµÑˆĞµĞ½!" >> $GITHUB_OUTPUT
        elif [ "${{ needs.health-check.result }}" = "skipped" ]; then
          echo "status=skipped" >> $GITHUB_OUTPUT
          echo "icon=â­ï¸" >> $GITHUB_OUTPUT
          echo "message=Health check Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½" >> $GITHUB_OUTPUT
        else
          echo "status=warning" >> $GITHUB_OUTPUT
          echo "icon=âš ï¸" >> $GITHUB_OUTPUT
          echo "message=Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½ Ñ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸ÑĞ¼Ğ¸" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ“¢ Notify deploy complete
      run: |
        echo "${{ steps.status.outputs.icon }} ${{ steps.status.outputs.message }}"
        echo "ğŸš‚ Railway Production Deploy Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo "ğŸ”— View logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  rollback-on-failure:
    name: ğŸ”„ Auto Rollback
    runs-on: ubuntu-latest
    needs: [health-check, smoke-tests]
    if: failure()

    steps:
    - name: âš ï¸ Deploy failed
      run: |
        echo "âŒ Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ»Ğ¸Ğ»ÑÑ!"
        echo "ğŸ”„ Ğ”Ğ»Ñ rollback:"
        echo "1. Ğ—Ğ°Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ğ½Ğ° Railway Dashboard"
        echo "2. Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğ¹ ÑƒÑĞ¿ĞµÑˆĞ½Ñ‹Ğ¹ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹"
        echo "3. ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ 'Redeploy'"
        echo ""
        echo "Ğ˜Ğ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ git revert:"
        echo "git revert HEAD"
        echo "git push origin main"

    - name: ğŸ“§ Alert on failure
      run: |
        echo "ğŸš¨ CRITICAL: Production deploy failed!"
        echo "Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ½ĞµĞ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾Ğµ Ğ²Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ"
